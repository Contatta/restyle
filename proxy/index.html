<!DOCTYPE html>
<html>
  <head>
    <meta charset='utf-8' />
    <meta name="description" content="Restyle : with" />
    <title>with(restyle.properties)</title>
    <script src="../test/build/restyle.js"></script>
    <script src="../test/build/restyle.max.proxy.js"></script>
    <script src="../javascripts/cssbeautify.js"></script>
    <script>
    with(restyle.proxy) {
      restyle({
        'html, body, div, textarea, pre': {
          overflowX: hidden,
          font: {
            size: 14,
            family: monospace
          },
          lineHeight: 16,
          padding: 0,
          margin: 0,
          border: none,
          width: '100%',
          height: '100%'
        },
        'div > div': {
          padding: '1%',
          height: '98%'
        },
        'body > div:nth-child(2)': {
          backgroundColor: black,
          color: white
        },
        'body > div': {
          width: '50%',
          float: left
        }
      });
    }
    this.onload = function () {
      /*@cc_on // @source https://gist.github.com/WebReflection/7286687
      (function(f){
       window.setTimeout =f(window.setTimeout);
       window.setInterval =f(window.setInterval);
      })(function(f){return function(c,t){var a=[].slice.call(arguments,2);return f(function(){c.apply(this,a)},t)}});
      @*/
      var Delayed=function(e){function d(){Infinity===this.waiting&&0===this.waiting||clearTimeout(this.waiting);this.waiting=0}function f(c,b,a,d){c.waiting=0;b.apply(a,d)}function c(e,b){function a(){d.call(a);a.waiting=setTimeout(f,b,a,e,this,arguments)}b||(b=c.delay);a.clear=d;a.waiting=Infinity;return a}c.delay=e;return c}(500);
      var
        simpleVar = '/\\$[0-9a-zA-Z_]+/',
        $restyle = [
          'return function s(t, y, l, e) {',
            'for (y in t) {',
              'if (t.hasOwnProperty(y)) {',
                'l = t[y];',
                'if (' + simpleVar + '.test(y)) {',
                  'delete t[y];',
                  't[y.replace(' + simpleVar + 'g, function (varName) {',
                    'return eval(varName);',
                  '})] = l;',
                '}',
                'if (typeof l === "object") {',
                  's(l, y, e, 1)',
                '}',
              '}',
            '}',
            'return e || restyle(t)',
          '}'
        ].join('\n'),
        textarea = document.getElementsByTagName('textarea')[0],
        pre = document.getElementsByTagName('pre')[0],
        textContent = 'textContent' in pre ? 'textContent' : 'innerText',
        value = location.href.split('?')[1],
        restyle = window.restyle
      ;
      (window.restyle = function (object) {
        return restyle(
          object,
          [],
          {
            createElement: Object,
            head: {
              insertBefore: function () {
                return {
                  styleSheet: {}
                };
              }
            }
          }
        ).node.styleSheet.cssText;
      }).proxy = restyle.proxy;
      pre.onclick = function () {
        location.href = location.href.split('?')[0] + '?' +
          encodeURIComponent(btoa(textarea.value.replace(/^\s+|\s+$/g, '')));
      };
      textarea.onkeyup = Delayed(function () {
        value = textarea.value.replace(/^\s+|\s+$/g, '');
        if (value.length) {
          try {
            value = Function(
              'with(restyle.proxy){' + (
                value.indexOf('restyle') < 0 ?
                  'return restyle(' + value + ')' :
                  value.replace('restyle', $restyle)
              ) + '}'
            )();
            pre[textContent] = cssbeautify(value, {
              indent: '  ',
              openbrace: 'end-of-line',
              autosemicolon: false
            });
          } catch(o_O){
            alert(o_O);
            throw o_O;
          }
        }
      });
      if (value) {
        textarea.value = atob(decodeURIComponent(value));
      }
      textarea.onkeyup.call(textarea);
    };
    </script>
  </head>
  <body>
    <div><div><textarea autofocus>$color = rgb('#ABC');

$others = ['input', 'textarea', 'pre'];

restyle({
  'html,body,$others': {
    font: {
      size: 14,
      family: monospace,
      color: $color
    }
  }
});</textarea></div></div>
    <div><div><pre></pre></div></div>
  </body>
</html>
